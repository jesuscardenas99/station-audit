<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Audit Analysis</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg-dark: #212529;
        --surface-dark: #363c42;
        --primary-blue: #3583dc;
        --border-color: #4f565e;
        --text-light: #eff5fa;
        --text-muted: #b8bec5;
      }

      body {
        background-color: var(--bg-dark);
        color: var(--text-light);
      }

      .navbar {
        background-color: black !important;
        border-bottom: 2px solid var(--primary-blue);
      }

      .navbar-light .navbar-brand,
      .navbar-light .navbar-nav .nav-link {
        color: var(--text-light) !important;
        transition: color 0.2s ease-in-out;
        margin-left: 10px;
        margin-right: 10px;
      }

      .navbar-light .navbar-nav .nav-link:hover {
        color: var(--primary-blue) !important;
      }

      .card {
        background-color: whitesmoke;
        border: 1px solid var(--border-color);
      }
      .card-header {
        background-color: var(--bg-dark);
        border-bottom: 1px solid var(--border-color);
      }

      .form-instruction,
      .form-select {
        background-color: white;
        color: black;
        border: 1px solid var(--text-muted);
      }

      .btn-primary {
        background-color: var(--primary-blue);
        border-color: var(--primary-blue);
      }
      .btn-primary:hover,
      .btn-primary:focus,
      .btn-primary:active,
      .btn-primary.active,
      .open > .dropdown-toggle.btn-primary {
        background-color: #f35161;
        border-color: #f35161;
      }
      .chart-container {
        background-color: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        height: 100%;
        border: 1px solid var(--border-color);
      }
      .chart-container h2 {
        color: black;
      }

      .nav-tabs {
        border-bottom-color: #f35161;
        display: flex;
      }
      .nav-tabs .nav-link {
        background-color: transparent;
        border-color: white;
        color: var(--text-muted);
      }
      .nav-tabs .nav-link.active {
        color: black;
        background-color: white;
        border-color: var(--border-color) var(--border-color)
          var(--surface-dark);
      }
      .nav-tabs .nav-link:hover {
        border-color: #f35161;
        color: var(--primary-blue);
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-md bg-light navbar-light shadow-sm">
      <div class="container">
        <img src="img/logo.png" alt="Logo" width="6%" style="float: left" />
        <a href="./dashboard.html" class="navbar-brand">Home</a>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a href="./escalations.html" class="nav-link">Audit Items</a>
            </li>
            <li class="nav-item">
              <a href="./instructionEscalations.html" class="nav-link"
                >Work Instruction Items</a
              >
            </li>
            <li class="nav-item">
              <a href="./analysis_overview.html" class="nav-link"
                >Overview Analysis</a
              >
            </li>
            <li class="nav-item" id="admin-nav-item">
              <a href="./admin.html" class="nav-link">Admin Page</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container mt-5">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-md-2">
              <label for="startDate" class="form-label"
                ><strong>Start Date</strong></label
              >
              <input type="date" class="form-instruction" id="startDate" />
            </div>
            <div class="col-md-2">
              <label for="endDate" class="form-label"
                ><strong>End Date</strong></label
              >
              <input type="date" class="form-instruction" id="endDate" />
            </div>
            <div class="col-md-2">
              <label for="areaSelect" class="form-label"
                ><strong>Area</strong></label
              >
              <select id="areaSelect" class="form-select"></select>
            </div>
            <div class="col-md-2">
              <label for="stationSelect" class="form-label"
                ><strong>Station</strong></label
              >
              <select id="stationSelect" class="form-select"></select>
            </div>
            <div class="col-md-2">
              <label for="shiftSelect" class="form-label"
                ><strong>Shift</strong></label
              >
              <select id="shiftSelect" class="form-select">
                <option value="">All Shifts</option>
                <option value="Day">Day</option>
                <option value="Swing">Swing</option>
                <option value="Grave">Night</option>
              </select>
            </div>
            <div class="col-md-2">
              <button id="apply-filters-btn" class="btn btn-primary w-100">
                Apply
              </button>
            </div>
          </div>
        </div>
      </div>

      <ul
        class="nav nav-tabs nav-justified mb-3"
        id="analysisTabs"
        role="tablist"
      >
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="performance-tab"
            data-bs-toggle="tab"
            data-bs-target="#performance-pane"
            type="button"
            role="tab"
          >
            Score Performance
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="volume-tab"
            data-bs-toggle="tab"
            data-bs-target="#volume-pane"
            type="button"
            role="tab"
          >
            Audit Count
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="instruction-tab"
            data-bs-toggle="tab"
            data-bs-target="#instruction-pane"
            type="button"
            role="tab"
          >
            Work Instruction
          </button>
        </li>
      </ul>

      <div class="tab-content" id="analysisTabsContent">
        <div
          class="tab-pane fade show active"
          id="performance-pane"
          role="tabpanel"
        >
          <div class="row">
            <div class="col-lg-8 mb-4">
              <div class="chart-container shadow-sm">
                <h2 class="text-center h4 mb-3">Failures by Station</h2>
                <canvas id="stationFailuresChart"></canvas>
              </div>
            </div>
            <div class="col-lg-4 mb-4">
              <div class="chart-container shadow-sm">
                <h2 class="text-center h4 mb-3">Response Breakdown</h2>
                <canvas id="scoreDonutChart"></canvas>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12 mb-4">
              <div class="chart-container shadow-sm">
                <h2 class="text-center h4 mb-3">
                  Average Quality Percentage by Month
                </h2>
                <canvas id="monthlyQualityChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="volume-pane" role="tabpanel">
          <div class="row">
            <div class="col-lg-8 mb-4">
              <div class="chart-container shadow-sm">
                <h2 class="text-center h4 mb-3">Audit Count by Station</h2>
                <canvas id="auditCountChart"></canvas>
              </div>
            </div>
            <div class="col-lg-4 mb-4">
              <div class="chart-container shadow-sm">
                <h2 class="text-center h4 mb-3">Tech Audit Count</h2>
                <canvas id="techCountChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="instruction-pane" role="tabpanel">
          <div class="row" style="justify-content: center">
            <div class="col-lg-8 mb-4">
              <div class="chart-container shadow-sm">
                <h2 class="text-center h4 mb-3">Work Instruction Issues</h2>
                <canvas id="instructionIssuesChart"></canvas>
              </div>
            </div>

            <div class="col-lg-8 mb-4">
              <div class="chart-container shadow-sm">
                <h2 class="text-center h4 mb-3">Work Instruction Not Done</h2>
                <canvas id="instructionFailuresChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.5.0/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const API_BASE_URL = "/system/webdev/Quality/tech_audit/Springfield";

        const areaSelect = document.getElementById("areaSelect");
        const stationSelect = document.getElementById("stationSelect");
        let stationChart,
          scoreChart,
          auditCount,
          techCount,
          instructionChart,
          issuesChart,
          monthlyChart;

        async function populateAreaFilter() {
          areaSelect.innerHTML = '<option value="">All Areas</option>';
          const response = await fetch(`${API_BASE_URL}/api/active_areas`);
          const areas = await response.json();
          areas.forEach((area) => {
            areaSelect.add(new Option(area.area_name, area.area_id));
          });
        }

        async function populateStationFilter(areaId) {
          stationSelect.innerHTML = '<option value="">All Stations</option>';
          if (!areaId) return;

          const response = await fetch(
            `${API_BASE_URL}/api/stations_by_area?area_id=${areaId}`,
          );
          const stations = await response.json();
          stations.forEach((s) => {
            stationSelect.add(new Option(s.station_name, s.station_id));
          });
        }

        areaSelect.addEventListener("change", () => {
          populateStationFilter(areaSelect.value);
        });

        document
          .getElementById("apply-filters-btn")
          .addEventListener("click", async () => {
            const params = new URLSearchParams({
              start_date: document.getElementById("startDate").value,
              end_date: document.getElementById("endDate").value,
              area_id: document.getElementById("areaSelect").value,
              station_id: document.getElementById("stationSelect").value,
              shift: document.getElementById("shiftSelect").value,
            });

            try {
              const [
                stationData,
                scoreData,
                auditCount,
                techData,
                instructionData,
                issuesData,
                monthlyQualityData,
              ] = await Promise.all([
                fetch(
                  `${API_BASE_URL}/api/failures_by_station?${params.toString()}`,
                ).then((res) => res.json()),
                fetch(
                  `${API_BASE_URL}/api/score_breakdown?${params.toString()}`,
                ).then((res) => res.json()),
                fetch(
                  `${API_BASE_URL}/api/audit_station_count?${params.toString()}`,
                ).then((res) => res.json()),
                fetch(
                  `${API_BASE_URL}/api/tech_audit_count?${params.toString()}`,
                ).then((res) => res.json()),
                fetch(
                  `${API_BASE_URL}/api/failures_by_station_instruction?${params.toString()}`,
                ).then((res) => res.json()),
                fetch(
                  `${API_BASE_URL}/api/instruction_issues_by_station?${params.toString()}`,
                ).then((res) => res.json()),
                fetch(
                  `${API_BASE_URL}/api/monthly_quality_scores?${params.toString()}`,
                ).then((res) => res.json()),
              ]);

              createStationFailures(stationData);
              createScoreDonutChart(scoreData);
              createAuditCount(auditCount);
              createTechCount(techData);
              createInstructionFailures(instructionData);
              createInstructionIssues(issuesData);
              createMonthlyQualityChart(monthlyQualityData);
            } catch (error) {
              console.error("Failed to fetch chart data:", error);
              alert("Could not load chart data. Please check the logs.");
            }
          });

        function createMonthlyQualityChart(data) {
          if (monthlyChart) monthlyChart.destroy();
          const ctx = document.getElementById("monthlyQualityChart");
          if (!data || data.length === 0) {
            ctx.getContext("2d").clearRect(0, 0, ctx.width, ctx.height);
            return;
          }

          const labels = data.map((item) => item.month);
          const values = data.map((item) => item.average_score);

          monthlyChart = new Chart(ctx, {
            type: "line",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Average Quality %",
                  data: values,
                  fill: false,
                  borderColor: "rgb(75, 192, 192)",
                  tension: 0.1,
                  pointBackgroundColor: "rgb(75, 192, 192)",
                  pointRadius: 5,
                },
              ],
            },
            options: {
              scales: {
                y: {
                  beginAtZero: false,
                  suggestedMin: 50,
                  suggestedMax: 100,
                  ticks: {
                    callback: function (value, index, ticks) {
                      return value + "%";
                    },
                  },
                },
              },

              plugins: {
                legend: {
                  display: false,
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      return `Avg Quality: ${context.parsed.y}%`;
                    },
                  },
                },
              },
            },
          });
        }

        function createStationFailures(data) {
          if (stationChart) stationChart.destroy();
          const ctx = document.getElementById("stationFailuresChart");
          if (!data || data.length === 0) {
            ctx.getContext("2d").clearRect(0, 0, ctx.width, ctx.height);
            return;
          }

          const labels = data.map(
            (item) => `${item.area_name} - ${item.station_name}`,
          );
          const values = data.map((item) => item.failure_count);

          stationChart = new Chart(ctx, {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "# of Failures",
                  data: values,
                  backgroundColor: "rgba(255, 90, 90, 1)",
                  borderColor: "rgba(210, 72, 72, 1)",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              scales: { y: { beginAtZero: true } },
              plugins: {
                legend: {
                  display: false,
                },
              },
            },
          });
        }

        function createScoreDonutChart(data) {
          if (scoreChart) scoreChart.destroy();
          const ctx = document
            .getElementById("scoreDonutChart")
            .getContext("2d");
          const scoreMap = { 0: 0, 1: 0, 2: 0 };
          data.forEach((item) => {
            scoreMap[item.score] = item.score_count;
          });

          scoreChart = new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: ["Compliant (2)", "Partial (1)", "Noncompliant (0)"],
              datasets: [
                {
                  label: "Total Responses",
                  data: [scoreMap[2], scoreMap[1], scoreMap[0]],
                  backgroundColor: [
                    "rgb(75, 192, 137)",
                    "rgb(255, 230, 86)",
                    "rgb(255, 99, 99)",
                  ],
                  borderColor: [
                    "rgba(75, 192, 192, 1)",
                    "rgba(255, 206, 86, 1)",
                    "rgba(255, 99, 132, 1)",
                  ],
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: { legend: { position: "top" } },
            },
          });
        }
        function createAuditCount(data) {
          if (auditCount) auditCount.destroy();
          const ctx = document.getElementById("auditCountChart");
          if (!data || data.length === 0) {
            ctx.getContext("2d").clearRect(0, 0, ctx.width, ctx.height);
            return;
          }

          const labels = data.map(
            (item) => `${item.area_name} - ${item.station_name}`,
          );
          const values = data.map((item) => item.audit_count);

          auditCount = new Chart(ctx, {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "# of Audits",
                  data: values,
                  backgroundColor: "rgba(255, 90, 90, 1)",
                  borderColor: "rgba(210, 72, 72, 1)",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              scales: { y: { beginAtZero: true } },
              plugins: {
                legend: {
                  display: false,
                },
              },
            },
          });
        }
        function createTechCount(data) {
          if (techCount) techCount.destroy();
          const ctx = document.getElementById("techCountChart");

          const labels = data.map((item) => `${item.qa_tech_username}`);
          const values = data.map((item) => item.tech_count);

          techCount = new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Audits",
                  data: values,

                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: { legend: { position: "top" } },
            },
          });
        }
        function createInstructionFailures(data) {
          if (instructionChart) instructionChart.destroy();
          const ctx = document.getElementById("instructionFailuresChart");
          if (!data || data.length === 0) {
            ctx.getContext("2d").clearRect(0, 0, ctx.width, ctx.height);
            return;
          }

          const labels = data.map(
            (item) => `${item.area_name} - ${item.station_name}`,
          );
          const values = data.map((item) => item.instruction_failure_count);

          instructionChart = new Chart(ctx, {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "# of Failures",
                  data: values,
                  backgroundColor: "#66b6d2",
                  borderColor: "#3ba1c5",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              scales: { y: { beginAtZero: true } },
              plugins: {
                legend: {
                  display: false,
                },
              },
            },
          });
        }
        function createInstructionIssues(data) {
          if (issuesChart) issuesChart.destroy();
          const ctx = document.getElementById("instructionIssuesChart");
          if (!data || data.length === 0) {
            ctx.getContext("2d").clearRect(0, 0, ctx.width, ctx.height);
            return;
          }

          const labels = data.map(
            (item) => `${item.area_name} - ${item.station_name}`,
          );
          const values = data.map((item) => item.instruction_issue_count);

          issuesChart = new Chart(ctx, {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "# of issues",
                  data: values,
                  backgroundColor: "rgba(255, 90, 90, 1)",
                  borderColor: "rgba(210, 72, 72, 1)",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              scales: { y: { beginAtZero: true } },
              plugins: {
                legend: {
                  display: false,
                },
              },
            },
          });
        }
        populateAreaFilter().then(() => {
          populateStationFilter(areaSelect.value);
          document.getElementById("apply-filters-btn").click();
        });
      });
    </script>
  </body>
</html>
